package com.suppliq.manufacturepro.Controllers;

import com.suppliq.manufacturepro.Database.DataCache;
import com.suppliq.manufacturepro.Database.ProductDAO;
import com.suppliq.manufacturepro.Models.Product;
import com.suppliq.manufacturepro.Utils.ColumnWidths;
import com.suppliq.manufacturepro.Utils.LoggerManager;
import javafx.application.Platform;
import javafx.beans.property.SimpleDoubleProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.collections.transformation.SortedList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.HBox;
import javafx.stage.Stage;

import java.io.IOException;
import java.util.List;



public class ProductController {

    @FXML private TableView<Product> productTable;
    @FXML private TableColumn<Product, Integer> columnId;
    @FXML private TableColumn<Product, String> columnName;
    @FXML private TableColumn<Product, String> columnDescription;
    @FXML private TableColumn<Product, Double> columnPrice;
    @FXML private TableColumn<Product, Integer> columnStock;
    @FXML private TableColumn<Product, String> columnCategory;
    @FXML private TableColumn<Product, Void> columnActions;
    @FXML private TextField searchField;
    @FXML private Button addProductButton;

    // ×¨×©×™××ª ××•×¦×¨×™× ×“×™× ××™×ª ×¢×‘×•×¨ ×”-TableView
    private ObservableList<Product> originalProductList = FXCollections.observableArrayList();

    @FXML
    public void initialize() {
        // ×§×™×©×•×¨ ×¢××•×“×•×ª ×‘×˜×‘×œ×” ×œ×©×“×•×ª ×‘××—×œ×§×ª ×”××•×“×œ
        columnId.setCellValueFactory(new PropertyValueFactory<>("id"));
        columnName.setCellValueFactory(new PropertyValueFactory<>("name"));
        columnDescription.setCellValueFactory(new PropertyValueFactory<>("description"));
        columnPrice.setCellValueFactory(new PropertyValueFactory<>("price"));
        columnStock.setCellValueFactory(new PropertyValueFactory<>("stockQuantity"));
        columnCategory.setCellValueFactory(new PropertyValueFactory<>("category"));

        // ×™×¦×™×¨×ª ×¢××•×“×ª ×¤×¢×•×œ×•×ª ×¢× ×›×¤×ª×•×¨×™ ×¢×¨×™×›×” ×•××—×™×§×”
        columnActions.setCellFactory(param -> new TableCell<>() {
            private final Button editButton = new Button(" ×¢×¨×•×š âœ ");
            private final Button deleteButton = new Button("××—×§ ğŸ—‘ ");
            private final HBox actionBox = new HBox(10, editButton, deleteButton);

            {
                editButton.getStyleClass().addAll("edit-button", "action-button", "button");
                deleteButton.getStyleClass().addAll("delete-button", "action-button", "button");
            }

            @Override
            protected void updateItem(Void item, boolean empty) {
                super.updateItem(item, empty);
                if (empty || getIndex() >= getTableView().getItems().size()) {
                    setGraphic(null);
                    return;
                }
                Product currentProduct = getTableView().getItems().get(getIndex());
                editButton.setOnAction(event -> editProduct(currentProduct));
                deleteButton.setOnAction(event -> deleteProduct(currentProduct));
                setGraphic(actionBox);
            }
        });

        loadProducts();

        configureTableColumns();

    }

    private void configureTableColumns() {
        productTable.setColumnResizePolicy(TableView.UNCONSTRAINED_RESIZE_POLICY);

        columnId.setMinWidth(70);
        columnId.setPrefWidth(70);
        columnId.setMaxWidth(70);
        //columnId.setResizable(false);

        columnName.setMinWidth(140);
        columnName.setPrefWidth(140);
        columnName.setMaxWidth(140);
        //columnName.setResizable(false);

        columnPrice.setMinWidth(60);
        columnPrice.setPrefWidth(60);
        columnPrice.setMaxWidth(60);
        //columnPrice.setResizable(false);

        columnStock.setMinWidth(50);
        columnStock.setPrefWidth(50);
        columnStock.setMaxWidth(50);
        //columnStock.setResizable(false);

        columnCategory.setMinWidth(80);
        columnCategory.setPrefWidth(80);
        columnCategory.setMaxWidth(80);
        //columnCategory.setResizable(false);

        columnActions.setMinWidth(180);
        columnActions.setPrefWidth(180);
        columnActions.setMaxWidth(180);
        //columnActions.setResizable(false);

        //columnDescription.setResizable(false);

        // ×—×™×©×•×‘ ××“×•×™×§ ××—×¨×™ ×©×”Ö¾TableView ×¡×™×™× ×¨×™× ×“×•×¨
        Platform.runLater(() -> {
            double totalWidth =
                    columnId.getWidth() +
                            columnName.getWidth() +
                            columnPrice.getWidth() +
                            columnStock.getWidth() +
                            columnCategory.getWidth() +
                            columnActions.getWidth();

            double tableWidth = productTable.getMaxWidth();
            double descriptionWidth = tableWidth - totalWidth;
            LoggerManager.logDebug(descriptionWidth+"");
            LoggerManager.logDebug(totalWidth+"");
            LoggerManager.logDebug(tableWidth+"");
            // × ×•×•×“× ×©×”×•× ×œ× ×©×œ×™×œ×™ ××• ××¤×¡
            columnDescription.setPrefWidth(Math.max(0, descriptionWidth-1));
        });
    }


    private void loadProducts() {
        originalProductList.setAll(DataCache.products);
        setupFiltering();
    }

    private void setupFiltering() {
        FilteredList<Product> filteredData = new FilteredList<>(originalProductList, p -> true);

        searchField.textProperty().addListener((observable, oldValue, newValue) -> {
            filteredData.setPredicate(product -> {
                if (newValue == null || newValue.isEmpty()) {
                    return true;
                }
                String lowerCaseFilter = newValue.toLowerCase();
                return product.getName().toLowerCase().contains(lowerCaseFilter)
                        || product.getDescription().toLowerCase().contains(lowerCaseFilter)
                        || product.getCategory().toLowerCase().contains(lowerCaseFilter);
            });
        });

        SortedList<Product> sortedData = new SortedList<>(filteredData);
        sortedData.comparatorProperty().bind(productTable.comparatorProperty());

        productTable.setItems(sortedData);
    }

    private void openProductDialog(Product productToEdit) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/com/suppliq/manufacturepro/Views/add-product.fxml"));
            Parent root = loader.load();
            AddProductController controller = loader.getController();

            if (productToEdit != null) {
                controller.setProductToEdit(productToEdit);
            }

            Stage dialogStage = new Stage();
            dialogStage.setTitle(productToEdit == null ? "×”×•×¡×£ ××•×¦×¨ ×—×“×©" : "×¢×¨×•×š ××•×¦×¨");
            dialogStage.setScene(new Scene(root));
            dialogStage.showAndWait();

            // ×¨×¢× ×•×Ÿ ×”× ×ª×•× ×™× ××”-DAO ×•×”×¦×’×ª× ××”-Cache
            DataCache.products = ProductDAO.getProducts();
            loadProducts();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void addProduct() {
        openProductDialog(null);
    }

    private void editProduct(Product product) {
        openProductDialog(product);
    }

    private void deleteProduct(Product product) {
        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
        alert.setTitle("××™×©×•×¨ ××—×™×§×”");
        alert.setHeaderText(null);
        alert.setContentText("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª \"" + product.getName() + "\"?");

        alert.showAndWait().ifPresent(response -> {
            if (response == ButtonType.OK) {
                ProductDAO.deleteProduct(product.getId());
                DataCache.products = ProductDAO.getProducts();
                loadProducts();
            }
        });
    }

    // ××¤×©×¨×•×ª ×œ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×–×• ×× ×¨×•×¦×™× ×œ×”×›× ×™×¡ ××•×¦×¨×™× ××‘×—×•×¥
    public void setProductList(List<Product> products) {
        originalProductList.setAll(products);
        productTable.setItems(originalProductList);
    }
}
